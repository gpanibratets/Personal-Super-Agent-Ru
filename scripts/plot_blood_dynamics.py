#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞ –¥–∏–Ω–∞–º–∏–∫–∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π –∫—Ä–æ–≤–∏ –º–µ–∂–¥—É –¥–≤—É–º—è –∞–Ω–∞–ª–∏–∑–∞–º–∏.
"""

import sys
from pathlib import Path
import matplotlib.pyplot as plt
import matplotlib.dates as mdates
from datetime import datetime
import numpy as np

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ matplotlib
try:
    import matplotlib
    matplotlib.use('Agg')  # –î–ª—è —Ä–∞–±–æ—Ç—ã –±–µ–∑ GUI
except ImportError:
    print("‚ùå –û—à–∏–±–∫–∞: –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ 'matplotlib' –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞.")
    print("   –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ—ë –∫–æ–º–∞–Ω–¥–æ–π: pip3 install matplotlib")
    sys.exit(1)

# –î–∞–Ω–Ω—ã–µ –∏–∑ –∞–Ω–∞–ª–∏–∑–∞ –æ—Ç 30.07.2025 (INVITRO)
data_july = {
    'date': datetime(2025, 7, 30),
    '–ì–µ–º–æ–≥–ª–æ–±–∏–Ω': 152,
    '–≠—Ä–∏—Ç—Ä–æ—Ü–∏—Ç—ã': 4.95,
    '–õ–µ–π–∫–æ—Ü–∏—Ç—ã': 5.88,
    '–ì–µ–º–∞—Ç–æ–∫—Ä–∏—Ç': 42.6,
    'MCV': 86.1,
    'MCH': 30.7,
    'MCHC': 357,  # 35.7 –≥/–¥–ª –≤ –∏—Å—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –Ω–æ –Ω–æ—Ä–º–∞ 32-37 —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –≤–æ–∑–º–æ–∂–Ω—É—é –æ—à–∏–±–∫—É –µ–¥–∏–Ω–∏—Ü. –ò—Å–ø–æ–ª—å–∑—É–µ–º 357 –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –Ω–æ—è–±—Ä—å—Å–∫–∏–º –¥–∞–Ω–Ω—ã–º
    'RDW': 12.6,
    '–¢—Ä–æ–º–±–æ—Ü–∏—Ç—ã': 239,
    '–°–û–≠': 2,
    '–õ–∏–º—Ñ–æ—Ü–∏—Ç—ã_%': 42.5,
    '–ú–æ–Ω–æ—Ü–∏—Ç—ã_%': 9.2,
    '–≠–æ–∑–∏–Ω–æ—Ñ–∏–ª—ã_%': 3.1,
    '–ë–∞–∑–æ—Ñ–∏–ª—ã_%': 1.5,
    '–ù–µ–π—Ç—Ä–æ—Ñ–∏–ª—ã_%': 43.7,
}

# –î–∞–Ω–Ω—ã–µ –∏–∑ –∞–Ω–∞–ª–∏–∑–∞ –æ—Ç 11.11.2025 (SOS Medical)
data_november = {
    'date': datetime(2025, 11, 11),
    '–ì–µ–º–æ–≥–ª–æ–±–∏–Ω': 157.0,
    '–≠—Ä–∏—Ç—Ä–æ—Ü–∏—Ç—ã': 5.0,
    '–õ–µ–π–∫–æ—Ü–∏—Ç—ã': 6.3,
    '–ì–µ–º–∞—Ç–æ–∫—Ä–∏—Ç': 43.8,
    'MCV': 86.8,
    'MCH': 31.1,
    'MCHC': 35.8,  # 358.0 –≥/–¥–ª = 35.8 –≥/–¥–ª (–∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è)
    'RDW': 13.0,
    '–¢—Ä–æ–º–±–æ—Ü–∏—Ç—ã': 222.0,
    '–°–û–≠': 6,
    '–õ–∏–º—Ñ–æ—Ü–∏—Ç—ã_%': 43.6,
    '–ú–æ–Ω–æ—Ü–∏—Ç—ã_%': 6.2,
    '–≠–æ–∑–∏–Ω–æ—Ñ–∏–ª—ã_%': 2.9,
    '–ë–∞–∑–æ—Ñ–∏–ª—ã_%': 0.0,
    '–°–µ–≥–º–µ–Ω—Ç–æ—è–¥–µ—Ä–Ω—ã–µ_%': 47.2,  # –ê–Ω–∞–ª–æ–≥ –Ω–µ–π—Ç—Ä–æ—Ñ–∏–ª–æ–≤
}

# –†–µ—Ñ–µ—Ä–µ–Ω—Å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
reference_ranges = {
    '–ì–µ–º–æ–≥–ª–æ–±–∏–Ω': (132, 173),
    '–≠—Ä–∏—Ç—Ä–æ—Ü–∏—Ç—ã': (4.3, 5.7),
    '–õ–µ–π–∫–æ—Ü–∏—Ç—ã': (4.5, 11),
    '–ì–µ–º–∞—Ç–æ–∫—Ä–∏—Ç': (39, 49),
    'MCV': (80, 99),
    'MCH': (27, 34),
    'MCHC': (32, 37),
    'RDW': (11.6, 14.8),
    '–¢—Ä–æ–º–±–æ—Ü–∏—Ç—ã': (150, 400),
    '–°–û–≠': (0, 15),
    '–õ–∏–º—Ñ–æ—Ü–∏—Ç—ã_%': (19, 37),
    '–ú–æ–Ω–æ—Ü–∏—Ç—ã_%': (3, 11),
    '–≠–æ–∑–∏–Ω–æ—Ñ–∏–ª—ã_%': (1, 5),
    '–ë–∞–∑–æ—Ñ–∏–ª—ã_%': (0, 1.0),
}

def create_blood_dynamics_plot():
    """–°–æ–∑–¥–∞–µ—Ç –≥—Ä–∞—Ñ–∏–∫ –¥–∏–Ω–∞–º–∏–∫–∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π –∫—Ä–æ–≤–∏."""
    
    # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
    categories = {
        '–û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏': ['–ì–µ–º–æ–≥–ª–æ–±–∏–Ω', '–≠—Ä–∏—Ç—Ä–æ—Ü–∏—Ç—ã', '–õ–µ–π–∫–æ—Ü–∏—Ç—ã', '–ì–µ–º–∞—Ç–æ–∫—Ä–∏—Ç'],
        '–ò–Ω–¥–µ–∫—Å—ã —ç—Ä–∏—Ç—Ä–æ—Ü–∏—Ç–æ–≤': ['MCV', 'MCH', 'MCHC', 'RDW'],
        '–¢—Ä–æ–º–±–æ—Ü–∏—Ç—ã –∏ –°–û–≠': ['–¢—Ä–æ–º–±–æ—Ü–∏—Ç—ã', '–°–û–≠'],
        '–õ–µ–π–∫–æ—Ü–∏—Ç–∞—Ä–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞ (%)': ['–õ–∏–º—Ñ–æ—Ü–∏—Ç—ã_%', '–ú–æ–Ω–æ—Ü–∏—Ç—ã_%', '–≠–æ–∑–∏–Ω–æ—Ñ–∏–ª—ã_%', '–ë–∞–∑–æ—Ñ–∏–ª—ã_%'],
    }
    
    dates = [data_july['date'], data_november['date']]
    
    # –°–æ–∑–¥–∞–µ–º —Ñ–∏–≥—É—Ä—É —Å –ø–æ–¥–≥—Ä–∞—Ñ–∏–∫–∞–º–∏
    fig, axes = plt.subplots(2, 2, figsize=(16, 12))
    fig.suptitle('–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π –∫—Ä–æ–≤–∏\n30.07.2025 (INVITRO) ‚Üí 11.11.2025 (SOS Medical)', 
                 fontsize=16, fontweight='bold')
    
    axes = axes.flatten()
    
    for idx, (category, indicators) in enumerate(categories.items()):
        ax = axes[idx]
        
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
        x_pos = np.arange(len(indicators))
        width = 0.35
        
        july_values = []
        november_values = []
        labels = []
        
        for indicator in indicators:
            # –î–ª—è MCHC –µ–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ (–≥/–¥–ª), –Ω–æ –∑–Ω–∞—á–µ–Ω–∏—è —Ä–∞–∑–Ω—ã–µ
            if indicator == 'MCHC':
                july_val = data_july.get(indicator, 0)  # 35.7 –≥/–¥–ª
                nov_val = data_november.get(indicator, 0)  # 358.0 –≥/–¥–ª (–Ω–æ—Ä–º–∞ 310-350)
                # –ù–æ—è–±—Ä—å—Å–∫–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ 10 —Ä–∞–∑ –±–æ–ª—å—à–µ - –≤–æ–∑–º–æ–∂–Ω–æ —Ä–∞–∑–Ω—ã–µ –µ–¥–∏–Ω–∏—Ü—ã –≤ –∏—Å—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                # –û—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å, –Ω–æ –æ—Ç–º–µ—Ç–∏–º –≤ –≥—Ä–∞—Ñ–∏–∫–µ
                july_values.append(july_val)
                november_values.append(nov_val)
            elif indicator == '–°–µ–≥–º–µ–Ω—Ç–æ—è–¥–µ—Ä–Ω—ã–µ_%':
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–µ–π—Ç—Ä–æ—Ñ–∏–ª—ã –∏–∑ –∏—é–ª—è –∏ —Å–µ–≥–º–µ–Ω—Ç–æ—è–¥–µ—Ä–Ω—ã–µ –∏–∑ –Ω–æ—è–±—Ä—è
                july_values.append(data_july.get('–ù–µ–π—Ç—Ä–æ—Ñ–∏–ª—ã_%', 0))
                november_values.append(data_november.get(indicator, 0))
            else:
                july_values.append(data_july.get(indicator, 0))
                november_values.append(data_november.get(indicator, 0))
            
            # –ö—Ä–∞—Å–∏–≤—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –¥–ª—è –æ—Å–µ–π
            label_map = {
                '–ì–µ–º–æ–≥–ª–æ–±–∏–Ω': '–ì–µ–º–æ–≥–ª–æ–±–∏–Ω\n(–≥/–ª)',
                '–≠—Ä–∏—Ç—Ä–æ—Ü–∏—Ç—ã': '–≠—Ä–∏—Ç—Ä–æ—Ü–∏—Ç—ã\n(–º–ª–Ω/–º–∫–ª)',
                '–õ–µ–π–∫–æ—Ü–∏—Ç—ã': '–õ–µ–π–∫–æ—Ü–∏—Ç—ã\n(—Ç—ã—Å/–º–∫–ª)',
                '–ì–µ–º–∞—Ç–æ–∫—Ä–∏—Ç': '–ì–µ–º–∞—Ç–æ–∫—Ä–∏—Ç\n(%)',
                'MCV': 'MCV\n(—Ñ–ª)',
                'MCH': 'MCH\n(–ø–≥)',
                'MCHC': 'MCHC\n(–≥/–¥–ª)',
                'RDW': 'RDW\n(%)',
                '–¢—Ä–æ–º–±–æ—Ü–∏—Ç—ã': '–¢—Ä–æ–º–±–æ—Ü–∏—Ç—ã\n(—Ç—ã—Å/–º–∫–ª)',
                '–°–û–≠': '–°–û–≠\n(–º–º/—á)',
                '–õ–∏–º—Ñ–æ—Ü–∏—Ç—ã_%': '–õ–∏–º—Ñ–æ—Ü–∏—Ç—ã\n(%)',
                '–ú–æ–Ω–æ—Ü–∏—Ç—ã_%': '–ú–æ–Ω–æ—Ü–∏—Ç—ã\n(%)',
                '–≠–æ–∑–∏–Ω–æ—Ñ–∏–ª—ã_%': '–≠–æ–∑–∏–Ω–æ—Ñ–∏–ª—ã\n(%)',
                '–ë–∞–∑–æ—Ñ–∏–ª—ã_%': '–ë–∞–∑–æ—Ñ–∏–ª—ã\n(%)',
                '–°–µ–≥–º–µ–Ω—Ç–æ—è–¥–µ—Ä–Ω—ã–µ_%': '–ù–µ–π—Ç—Ä–æ—Ñ–∏–ª—ã\n(%)',
            }
            labels.append(label_map.get(indicator, indicator))
        
        # –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
        bars1 = ax.bar(x_pos - width/2, july_values, width, label='30.07.2025', 
                      color='#4A90E2', alpha=0.8)
        bars2 = ax.bar(x_pos + width/2, november_values, width, label='11.11.2025', 
                      color='#50C878', alpha=0.8)
        
        # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π –Ω–∞ —Å—Ç–æ–ª–±—Ü—ã
        for bars in [bars1, bars2]:
            for bar in bars:
                height = bar.get_height()
                ax.text(bar.get_x() + bar.get_width()/2., height,
                       f'{height:.1f}',
                       ha='center', va='bottom', fontsize=8)
        
        ax.set_xlabel('–ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏', fontsize=10)
        ax.set_ylabel('–ó–Ω–∞—á–µ–Ω–∏–µ', fontsize=10)
        ax.set_title(category, fontsize=12, fontweight='bold')
        ax.set_xticks(x_pos)
        ax.set_xticklabels(labels, rotation=45, ha='right', fontsize=9)
        ax.legend(fontsize=9)
        ax.grid(True, alpha=0.3, axis='y')
    
    plt.tight_layout()
    
    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
    output_file = Path(__file__).parent.parent / 'Docs' / 'Health' / 'Medical-Records' / 'blood-dynamics-chart.png'
    output_file.parent.mkdir(parents=True, exist_ok=True)
    plt.savefig(output_file, dpi=300, bbox_inches='tight')
    print(f"‚úÖ –ì—Ä–∞—Ñ–∏–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω: {output_file}")
    
    return output_file

if __name__ == "__main__":
    try:
        output_file = create_blood_dynamics_plot()
        print(f"\nüìä –ì—Ä–∞—Ñ–∏–∫ –¥–∏–Ω–∞–º–∏–∫–∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π –∫—Ä–æ–≤–∏ —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ!")
        print(f"   –§–∞–π–ª: {output_file}")
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≥—Ä–∞—Ñ–∏–∫–∞: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)

